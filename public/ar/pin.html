<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RC Dev — Drop Pin</title>
  <!-- Browser-side Supabase (only used for client insert + session) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;background:#0b0b0b;color:#fff;font:15px system-ui}
    .wrap{max-width:720px;margin:24px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:12px}
    label{opacity:.9}
    input{padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .ok{background:#34c759;color:#000}
    .blue{background:#0a84ff;color:#fff}
    .red{background:#ff3b30;color:#fff}
    .gray{background:#2c2c2e;color:#fff}
    .row{display:grid;gap:8px}
    .hint{opacity:.7}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Drop Pin (Dev)</h2>

    <!-- AUTH CARD -->
    <div class="card">
      <div class="row">
        <label>Email (magic link)</label>
        <input id="email" placeholder="you@domain.com" />
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="login" class="blue">Send Magic Link</button>
          <button id="logout" class="red">Logout</button>
        </div>
        <div id="authStatus" style="opacity:.85"></div>
        <small class="hint">Tip: on iPhone, open the email link in <b>Safari</b> (not the Gmail in-app browser).</small>
      </div>
    </div>

    <!-- PIN FORM -->
    <div class="card">
      <div>GPS: <span id="gps">waiting…</span></div>
      <div class="row">
        <label>Title</label>
        <input id="title" placeholder="e.g. Park — 85th Street" />
      </div>
      <div class="row">
        <label>Model URL (GLB or viewer)</label>
        <!-- default points to your new GLB -->
        <input id="song" value="https://recordcatcher.b-cdn.net/glb/Nderec.glb" />
      </div>

      <!-- Buttons -->
      <div style="display:grid;gap:8px;margin-top:8px">
        <button id="dropAdmin" class="ok">Admin Drop (No Login)</button>
        <button id="dropClient" class="gray">Client Insert (Needs Login)</button>
        <button id="openHere" class="blue">Open Geo AR Here (No Auth)</button>
      </div>

      <div id="out" class="mono" style="white-space:pre-wrap;opacity:.9;margin-top:8px"></div>
    </div>

    <div class="card">
      <a class="blue" href="./geo.html" style="display:inline-block;padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none">Open Geo AR</a>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SUPABASE_URL = 'https://rlejpxhkftihlkchklwub.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZWpweGhrZnRpaGxjaGtsd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMDUyMDIsImV4cCI6MjA3MjY4MTIwMn0.CBunws9Ge-zi858JS7LBen6fTYV_0fZ1__D2VdjTDtM';
    const MASTER_UID = '2f545801-1368-418b-8533-aa3ee41806f2';
    const CANONICAL_SELF = new URL(location.pathname, location.origin).href; // current page absolute
    const TABLE = 'pins'; // <-- adjust if your table name differs

    // ===== Supabase client =====
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== UI refs =====
    const email = document.getElementById('email');
    const login = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const authStatus = document.getElementById('authStatus');
    const gps = document.getElementById('gps');
    const title = document.getElementById('title');
    const song = document.getElementById('song');
    const dropAdmin = document.getElementById('dropAdmin');
    const dropClient = document.getElementById('dropClient');
    const out = document.getElementById('out');
    const openHere = document.getElementById('openHere');

    // ===== Helpers =====
    function show(result) {
      out.textContent = typeof result === 'string'
        ? result
        : JSON.stringify(result, null, 2);
    }
    function withCacheBuster(url) {
      const raw = (url || '').trim();
      return raw + (raw.includes('?') ? '&' : '?') + 'v=' + Date.now();
    }
    function encodeModel(url) {
      return encodeURIComponent(withCacheBuster(url));
    }
    function geoHtmlURL() {
      return new URL('./geo.html', location.href).href;
    }

    // Promise-based current position (falls back to latestPos)
    let latestPos = null;
    async function getCurrentCoords() {
      if (!navigator.geolocation) throw new Error('Geolocation not supported');
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          p => resolve(p.coords),
          err => latestPos ? resolve(latestPos.coords) : reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // ===== Auth status =====
    async function refreshAuth() {
      const { data, error } = await sb.auth.getUser();
      if (error) { authStatus.textContent = 'Auth error: ' + error.message; return; }
      const user = data.user;
      authStatus.textContent = user
        ? `Signed in as: ${user.email} (${user.id === MASTER_UID ? 'MASTER' : 'user'})`
        : 'Not signed in';
    }
    sb.auth.onAuthStateChange(() => refreshAuth());
    refreshAuth();

    // Login: magic link
    login.onclick = async () => {
      const addr = (email.value || '').trim();
      if (!addr) return show('Enter an email first.');
      show('Sending magic link…');
      const { data, error } = await sb.auth.signInWithOtp({
        email: addr,
        options: { emailRedirectTo: CANONICAL_SELF }
      });
      if (error) return show(error);
      show('Magic link sent. Check your email and open it in Safari on iPhone.');
    };

    // Logout
    logoutBtn.onclick = async () => {
      await sb.auth.signOut();
      refreshAuth();
      show('Logged out.');
    };

    // Handle access_token in URL (after magic link)
    (async function handleMagicLink() {
      const hash = new URLSearchParams(location.hash.slice(1));
      if (hash.get('access_token')) {
        // Supabase JS handles this internally via onAuthStateChange; just tidy URL
        history.replaceState({}, '', location.pathname);
        refreshAuth();
        show('Logged in via magic link.');
      }
    })();

    // ===== GPS watcher (UI) =====
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(p => {
        latestPos = p;
        gps.textContent = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)} (±${Math.round(p.coords.accuracy)}m)`;
      }, e => { gps.textContent = 'Error: ' + e.message; }, { enableHighAccuracy: true });
    } else {
      gps.textContent = 'Geolocation not supported';
    }

    // ===== Open Geo AR Here =====
    openHere.onclick = async () => {
      try {
        openHere.disabled = true;
        const coords = await getCurrentCoords();
        const lat = coords.latitude.toFixed(6);
        const lng = coords.longitude.toFixed(6);
        if (gps) gps.textContent = `${lat}, ${lng} (±${Math.round(coords.accuracy)}m)`;

        const rawDefault = 'https://recordcatcher.b-cdn.net/glb/Nderec.glb';
        const modelParam = encodeModel(song.value || rawDefault);

        const url = `${geoHtmlURL()}?lat=${lat}&lng=${lng}&model=${modelParam}`;
        location.href = url;
      } catch (err) {
        alert('Location error: ' + err.message + '\n• Go outside / enable GPS\n• On iPhone use Safari');
      } finally {
        openHere.disabled = false;
      }
    };

    // ===== Admin Drop (no login required) =====
    dropAdmin.onclick = async () => {
      try {
        dropAdmin.disabled = true;
        show('Dropping (admin)…');

        const coords = await getCurrentCoords();
        const payload = {
          title: (title.value || '').trim() || 'Untitled Pin',
          model_url: withCacheBuster(song.value || 'https://recordcatcher.b-cdn.net/glb/Nderec.glb'),
          lat: Number(coords.latitude.toFixed(6)),
          lng: Number(coords.longitude.toFixed(6)),
          created_by: 'admin', // adjust for your schema
        };

        // Insert — requires RLS to allow anon insert or use a service function
        const { data, error } = await sb.from(TABLE).insert(payload).select('*').single();
        if (error) return show({ error });

        show({ ok: true, data });
      } catch (e) {
        show({ error: String(e) });
      } finally {
        dropAdmin.disabled = false;
      }
    };

    // ===== Client Insert (requires login) =====
    dropClient.onclick = async () => {
      try {
        dropClient.disabled = true;
        const { data: userData, error: userErr } = await sb.auth.getUser();
        if (userErr || !userData?.user) {
          show('You must be logged in to insert as client.');
          return;
        }

        show('Dropping (client)…');
        const coords = await getCurrentCoords();
        const payload = {
          title: (title.value || '').trim() || 'Untitled Pin',
          model_url: withCacheBuster(song.value || 'https://recordcatcher.b-cdn.net/glb/Nderec.glb'),
          lat: Number(coords.latitude.toFixed(6)),
          lng: Number(coords.longitude.toFixed(6)),
          created_by: userData.user.id, // adjust for your schema
        };

        const { data, error } = await sb.from(TABLE).insert(payload).select('*').single();
        if (error) return show({ error });

        show({ ok: true, data });
      } catch (e) {
        show({ error: String(e) });
      } finally {
        dropClient.disabled = false;
      }
    };
  </script>
</body>
</html>
