<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RC Dev — Drop Pin</title>

  <!-- Supabase JS v2 (global `supabase`) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;background:#0b0b0b;color:#fff;font:15px system-ui}
    .wrap{max-width:720px;margin:24px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:12px}
    label{opacity:.9}
    input{padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff}
    button{padding:10px 14px;border:0;border-radius:10px;font-weight:700}
    .ok{background:#34c759;color:#000}
    .blue{background:#0a84ff;color:#fff}
    .red{background:#ff3b30;color:#fff}
    .row{display:grid;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Drop Pin (Dev)</h2>

    <div class="card">
      <div class="row">
        <label>Email (magic link)</label>
        <input id="email" placeholder="you@domain.com" />
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="login" class="blue">Send Magic Link</button>
          <button id="logout" class="red">Logout</button>
        </div>
        <div id="authStatus" style="opacity:.85"></div>
        <small style="opacity:.7">Tip: on iPhone, open the email link in <b>Safari</b> (not the Gmail in-app browser).</small>
      </div>
    </div>

    <div class="card">
      <div>GPS: <span id="gps">waiting…</span></div>
      <div class="row">
        <label>Title</label>
        <input id="title" placeholder="e.g. Park — 85th Street" />
      </div>
      <div class="row">
        <label>Song URL (GLB or viewer)</label>
        <input id="song" value="https://recordcatcher.b-cdn.net/glb/NDE1%20record.glb" />
      </div>
      <button id="drop" class="ok">Drop Pin Here</button>
      <div id="out" style="white-space:pre-wrap;opacity:.9;margin-top:8px"></div>
    </div>

    <div class="card">
      <a class="blue" href="./geo.html" style="display:inline-block;padding:10px 14px;border-radius:10px;color:#fff;text-decoration:none">Open Geo AR</a>
    </div>
  </div>

  <script>
    // ===== Supabase setup (PUBLIC anon key is expected here) =====
    // Project URL copied from Supabase → Settings → API
    const SUPABASE_URL = 'https://rlejpxhkftihlkchklwub.supabase.co';
    // Your public anon key (okay to expose in browser apps with RLS enabled)
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZWpweGhrZnRpaGxjaGtsd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMDUyMDIsImV4cCI6MjA3MjY4MTIwMn0.CBunws9Ge-zi858JS7LBen6fTYV_0fZ1__D2VdjTDtM';

    // Optional: the "master" user id you want to allow to insert
    const MASTER_UID = '2f545801-1368-418b-8533-aa3ee41806f2';

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Canonical path (matches your Netlify redirects and Supabase allow-list)
    const CANONICAL_PATH = '/ar/pin'; // no .html

    // ===== UI refs =====
    const email = document.getElementById('email');
    const login = document.getElementById('login');
    const logout = document.getElementById('logout');
    const authStatus = document.getElementById('authStatus');
    const gps = document.getElementById('gps');
    const title = document.getElementById('title');
    const song = document.getElementById('song');
    const drop = document.getElementById('drop');
    const out = document.getElementById('out');

    // ===== URL normalization (keeps address bar on /ar/drop-pin) =====
    (function normalizeToCanonical(){
      const url = new URL(location.href);
      if (url.pathname !== CANONICAL_PATH) {
        // Don't navigate — just clean what we show after auth completes
        // (Netlify rewrites already serve drop-pin.html)
        // We'll replaceState after finishing auth below.
      }
    })();

    // ===== Auth status helper =====
    async function refreshAuth(){
      const { data, error } = await sb.auth.getUser();
      if (error) {
        authStatus.textContent = 'Auth error: ' + error.message;
        return;
      }
      const user = data.user;
      authStatus.textContent = user
        ? `Signed in as: ${user.email} (${user.id === MASTER_UID ? 'MASTER' : 'not master'})`
        : 'Not signed in';
    }

    sb.auth.onAuthStateChange(() => refreshAuth());
    refreshAuth();

    // ===== Finish login on landing (handles ?code= and #access_token=) =====
    async function finishLogin() {
      const href = location.href;
      const url = new URL(href);
      const code = url.searchParams.get('code');

      try {
        if (code) {
          const { error } = await sb.auth.exchangeCodeForSession(code);
          if (error) throw error;
          // Clean querystring and normalize path in address bar
          history.replaceState({}, document.title, CANONICAL_PATH);
          console.log('Logged in via code exchange.');
          return;
        }

        // Some providers/browsers deliver a hash with access_token
        if (href.includes('#access_token=')) {
          // Supabase JS picks up the hash on init; just verify session shortly
          setTimeout(async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
              history.replaceState({}, document.title, CANONICAL_PATH);
              console.log('Logged in via hash fragment.');
            } else {
              alert('Could not finalize session from hash.');
            }
          }, 0);
        }
      } catch (err) {
        console.error(err);
        alert('Login failed: ' + (err?.message || err));
      }
    }
    finishLogin();

    // ===== Send magic link (explicit redirect to canonical path) =====
    login.onclick = async () => {
      const addr = email.value.trim();
      if (!addr) return alert('Enter email');

      login.disabled = true;

      const redirectTo = `${location.origin}${CANONICAL_PATH}`;
      console.log('emailRedirectTo:', redirectTo);

      const { error } = await sb.auth.signInWithOtp({
        email: addr,
        options: {
          emailRedirectTo: redirectTo,
          shouldCreateUser: true
        }
      });

      login.disabled = false;

      if (error) {
        console.error('signInWithOtp error:', error);
        alert(
          `Login error: ${error.message}\n\n` +
          `Ensure this URL is whitelisted in Supabase:\n${redirectTo}`
        );
      } else {
        alert('Magic link sent. Open it in the SAME browser (Safari on iPhone).');
      }
    };

    // ===== Logout =====
    logout.onclick = async () => {
      logout.disabled = true;
      await sb.auth.signOut();
      await refreshAuth();
      logout.disabled = false;
    };

    // ===== GPS watcher =====
    let latestPos = null;
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(p => {
        latestPos = p;
        gps.textContent =
          `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)} (±${Math.round(p.coords.accuracy)}m)`;
      }, e => {
        gps.textContent = 'Error: ' + e.message;
      }, { enableHighAccuracy: true });
    } else {
      gps.textContent = 'Geolocation not supported';
    }

    // ===== Insert pin =====
    drop.onclick = async () => {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) return alert('Sign in first (magic link).');
      if (user.id !== MASTER_UID) {
        if (!confirm('You are not the MASTER user. Insert may fail due to RLS. Continue?')) return;
      }
      if (!latestPos) return alert('No GPS fix yet.');

      drop.disabled = true;

      const t = title.value.trim() || `Song @ ${new Date().toLocaleTimeString()}`;
      const s = song.value.trim() || 'https://recordcatcher.b-cdn.net/glb/NDE1%20record.glb';
      const { latitude, longitude } = latestPos.coords;

      const { data, error } = await sb
        .from('rc_pins')
        .insert({
          title: t,
          song_url: s,
          lat: latitude,
          lng: longitude,
          is_active: true,
          created_by: user.id
        })
        .select()
        .single();

      drop.disabled = false;

      out.textContent = error
        ? `Insert error: ${error.message}`
        : `Inserted:\n${JSON.stringify(data, null, 2)}`;
    };
  </script>
</body>
</html>
