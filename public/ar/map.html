<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RecordCatcher — Pin Maker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0b0b;--card:#111;--line:#222;--txt:#fff;--accent:#0a84ff;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font:15px system-ui}
    .wrap{display:grid;grid-template-columns:1fr 360px;height:100%}
    #map{height:100%}
    aside{border-left:1px solid var(--line);background:var(--card);display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:10px;border-bottom:1px solid var(--line)}
    footer{border-top:1px solid var(--line);border-bottom:0}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#222}
    .btn.save{background:#34c759;color:#000}
    .btn.danger{background:#ff3b30}
    .btn.gray{background:#1c1c1e}
    .list{overflow:auto}
    .pin{padding:10px;border-bottom:1px solid var(--line);display:grid;gap:6px}
    .row{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0e0e0e;color:#fff}
    .meta{opacity:.8;font-size:12px}
    .muted{opacity:.8}
    .note{padding:8px 10px;background:#0e0e0e;border-top:1px solid var(--line)}
    .topbar{
      position:fixed;left:0;right:0;top:0;padding:8px clamp(10px,4vw,16px);
      padding-top:calc(8px + var(--safe-top));
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      z-index:500; pointer-events:none;
    }
    .topbar .cluster{display:flex;gap:8px;pointer-events:auto}
    .btn-lg{padding:12px 14px;border-radius:12px;font-weight:800}
    .sheet{display:none}
    .backdrop{display:none}
    @media (max-width: 820px){
      .wrap{grid-template-columns:1fr}
      aside{display:none}
      .topbar{gap:10px}
      .btn-lg{min-height:44px}
      .sheet{
        display:block;position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);
        max-height:70vh;height:60vh;transform:translateY(100%);transition:transform .28s ease; z-index:600;
        padding-bottom:calc(10px + var(--safe-bot));box-shadow:0 -10px 40px rgba(0,0,0,.4);
        display:grid;grid-template-rows:auto 1fr auto;
      }
      .sheet.open{transform:translateY(0)}
      .sheet header, .sheet footer{padding:12px 14px;border-bottom:1px solid var(--line)}
      .sheet footer{border-bottom:0;border-top:1px solid var(--line)}
      .sheet .list{overflow:auto;-webkit-overflow-scrolling:touch}
      .backdrop{
        display:block;position:fixed;inset:0;background:rgba(0,0,0,.35);
        opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:550
      }
      .backdrop.show{opacity:1;pointer-events:auto}
      #map{margin-top:calc(54px + var(--safe-top))}
    }
    button{min-height:40px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="cluster">
      <button class="btn btn-lg" id="locateMe">My Location</button>
      <button class="btn btn-lg" id="openViewer">Open Viewer</button>
    </div>
    <div class="cluster">
      <button class="btn btn-lg ghost" id="toggleSheet">Pins</button>
    </div>
  </div>

  <div class="wrap">
    <div id="map"></div>

    <aside>
      <header><strong>Pin Maker</strong></header>
      <div class="list" id="pinList"></div>
      <footer><div class="meta" id="status">Click map to add a pin (5-ft radius, non-overlapping).</div></footer>
      <div class="note"><div class="meta">Default GLB is used if a pin’s <code>model_url</code> is empty.</div></div>
    </aside>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <div class="sheet" id="sheet">
    <header><strong>Pins</strong></header>
    <div class="list" id="pinListMobile"></div>
    <footer><div class="meta" id="statusMobile">Tap map to add a pin (5-ft radius, non-overlap).</div></footer>
  </div>

  <script>
    // === CONFIG ===
    const SUPABASE_URL = 'https://rlejpxhkftihlchklwub.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZWpweGhrZnRpaGxjaGtsd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxMDUyMDIsImV4cCI6MjA3MjY4MTIwMn0.CBunws9Ge-zi858JS7LBen6fTYV_0fZ1__D2VdjTDtM';
    const DEFAULT_GLB = 'https://recordcatcher.b-cdn.net/glb/Nderec.glb';
    const PIN_RADIUS_M = 1.524;            // 5 ft
    const NO_OVERLAP_MIN = PIN_RADIUS_M*2; // ~10 ft center-to-center

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = s => document.querySelector(s);

    // Desktop: make scroll zoom 5× less sensitive than before
    const map = L.map('map', {
      scrollWheelZoom: true,
      wheelDebounceTime: 250,
      wheelPxPerZoomLevel: 3000, // was 600
      zoomSnap: 1,
      zoomDelta: 1
    }).setView([40.7719, -73.9462], 14);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OSM'
    }).addTo(map);

    // Mobile bottom-sheet toggles
    const sheet = $('#sheet'), backdrop = $('#backdrop'), toggleBtn = $('#toggleSheet');
    const isMobile = () => window.matchMedia('(max-width: 820px)').matches;
    const openSheet = () => { if (isMobile()){ sheet.classList.add('open'); backdrop.classList.add('show'); setTimeout(()=>map.invalidateSize(), 300); } };
    const closeSheet = () => { sheet.classList.remove('open'); backdrop.classList.remove('show'); setTimeout(()=>map.invalidateSize(), 300); };
    toggleBtn.addEventListener('click', ()=> (sheet.classList.contains('open')? closeSheet(): openSheet()));
    backdrop.addEventListener('click', closeSheet);

    const state = { pins:[], markers:new Map() };

    // --- "My Location" temp layers (not saved) ---
    let meMarker = null, meCircle = null, meWatchId = null;
    function clearMeLayers(){
      if (meMarker){ map.removeLayer(meMarker); meMarker = null; }
      if (meCircle){ map.removeLayer(meCircle); meCircle = null; }
      if (meWatchId){ navigator.geolocation.clearWatch(meWatchId); meWatchId = null; }
    }
    function snapToMyLocation(){
      setStatus('Locating…');
      clearMeLayers();
      const draw = ({latitude, longitude, accuracy}) => {
        if (!meMarker) {
          meMarker = L.circleMarker([latitude, longitude], {radius:6,color:'#1982ff',fillColor:'#1982ff',fillOpacity:1,weight:2}).addTo(map);
          meCircle = L.circle([latitude, longitude], {radius: Math.max(accuracy, 10), color:'#1982ff', opacity:.25, fillOpacity:.08}).addTo(map);
          map.setView([latitude, longitude], Math.max(map.getZoom(), 16), {animate:true});
        } else {
          meMarker.setLatLng([latitude, longitude]);
          meCircle.setLatLng([latitude, longitude]);
          meCircle.setRadius(Math.max(accuracy, 10));
        }
        setStatus(`You: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy)} m)`);
      };
      navigator.geolocation.getCurrentPosition(
        pos => {
          draw(pos.coords);
          meWatchId = navigator.geolocation.watchPosition(
            p => draw(p.coords),
            e => console.warn('geo watch error', e),
            { enableHighAccuracy:true, maximumAge:2000, timeout:15000 }
          );
        },
        err => {
          const msg = err.code===1 ? 'Location permission denied.' :
                      err.code===2 ? 'Position unavailable.' :
                      err.code===3 ? 'Location timeout.' : 'Location error.';
          setStatus(msg);
          console.warn('geolocation error', err);
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:2000 }
      );
    }

    function fmt(v){ return Number(v).toFixed(6); }
    function distMeters(aLat,aLng,bLat,bLng){
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(bLat-aLat), dLon=toRad(bLng-aLng);
      const A=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(A));
    }

    function setStatus(msg){
      const el1 = document.getElementById('status');
      const el2 = document.getElementById('statusMobile');
      if (el1) el1.textContent = msg;
      if (el2) el2.textContent = msg;
    }

    // --- Build geo1 deep-link for a pin ---
    function buildGeoURL(p){
      const base = new URL('geo1.html', location.origin);
      base.searchParams.set('lat', p.lat.toFixed(6));
      base.searchParams.set('lng', p.lng.toFixed(6));
      base.searchParams.set('radius', (p.radius_m ?? PIN_RADIUS_M).toString());
      if (p.track_title) base.searchParams.set('title', p.track_title);
      if (p.model_url)  base.searchParams.set('glb',   p.model_url);
      if (p.audio_url)  base.searchParams.set('audio', p.audio_url);
      if (p.cover_url)  base.searchParams.set('cover', p.cover_url);
      return base.toString();
    }

    // Load pins from DB
    async function loadPins(){
      const {data, error} = await sb.from('pins').select('*').order('created_at',{ascending:false});
      if(error){ setStatus('Load error: '+error.message); return; }
      state.pins = data||[];
      renderPins();
    }

    // Draw markers + side/drawer lists
    function renderPins(){
      for (const [id, m] of state.markers.entries()){
        if (!state.pins.find(p=>p.id===id)) { map.removeLayer(m); state.markers.delete(id); }
      }
      state.pins.forEach(p=>{
        if (!state.markers.has(p.id)){
          const marker = L.marker([p.lat,p.lng], {draggable:true}).addTo(map);
          marker.on('dragend', async (e)=>{
            const ll = e.target.getLatLng();
            if (wouldOverlap(ll.lat, ll.lng, p.id)) {
              e.target.setLatLng([p.lat,p.lng]);
              alert('Too close to another pin (5-ft radius cannot overlap).');
            } else {
              await updatePin(p.id, {lat: ll.lat, lng: ll.lng});
            }
          });
          state.markers.set(p.id, marker);
        } else {
          state.markers.get(p.id).setLatLng([p.lat,p.lng]);
        }
      });

      const desktop = document.getElementById('pinList');
      const mobile  = document.getElementById('pinListMobile');
      if (desktop) desktop.innerHTML = '';
      if (mobile)  mobile.innerHTML = '';

      const buildRow = (p) => {
        const row = document.createElement('div');
        row.className='pin';
        row.innerHTML = `
          <div class="row">
            <input type="text" class="name" value="${p.name||''}" placeholder="Street · time" />
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="btn" data-find>Find</button>
              <button class="btn save">Save</button>
              <button class="btn danger del">Delete</button>
            </div>
          </div>
          <div class="meta">${fmt(p.lat)}, ${fmt(p.lng)} · radius ${(p.radius_m??PIN_RADIUS_M).toFixed(2)} m</div>
          <div class="row"><input type="text" class="title"  placeholder="Track title"               value="${p.track_title||''}"></div>
          <div class="row"><input type="text" class="artist" placeholder="Artist"                    value="${p.track_artist||''}"></div>
          <div class="row"><input type="text" class="cover"  placeholder="Cover URL (optional)"      value="${p.cover_url||''}"></div>
          <div class="row"><input type="text" class="audio"  placeholder="Audio URL (Bunny)"         value="${p.audio_url||''}"></div>
          <div class="row"><input type="text" class="model"  placeholder="Model URL (GLB optional)"  value="${p.model_url||''}"></div>
          <div class="meta muted">Drag the marker to adjust. Changes save when you hit <b>Save</b>.</div>
        `;

        // FIND button → open geo1 with this pin’s params
        row.querySelector('[data-find]').onclick = () => {
          const url = buildGeoURL(p);
          // same tab for quick testing; switch to window.open(url, '_blank') if you want a new tab
          location.href = url;
        };

        // SAVE button
        row.querySelector('.save').onclick = async () => {
          const patch = {
            name:         row.querySelector('.name').value,
            track_title:  row.querySelector('.title').value,
            track_artist: row.querySelector('.artist').value,
            cover_url:    row.querySelector('.cover').value,
            audio_url:    row.querySelector('.audio').value,
            model_url:    row.querySelector('.model').value
          };
          await updatePin(p.id, patch);
          alert('Pin saved!');
        };

        // DELETE button
        row.querySelector('.del').onclick = async ()=>{
          if (!confirm('Delete this pin?')) return;
          const {error} = await sb.from('pins').delete().eq('id', p.id);
          if(error) return alert(error.message);
          await loadPins();
        };
        return row;
      };

      state.pins.forEach(p=>{
        if (desktop) desktop.appendChild(buildRow(p));
        if (mobile)  mobile.appendChild(buildRow(p));
      });
    }

    function wouldOverlap(lat,lng, ignoreId=null){
      return state.pins.some(p=>{
        if (ignoreId && p.id===ignoreId) return false;
        const d = distMeters(lat,lng,p.lat,p.lng);
        const min = (p.radius_m||PIN_RADIUS_M) + PIN_RADIUS_M;
        return d < min;
      });
    }

    map.on('click', async (e)=>{
      const {lat,lng} = e.latlng;
      if (wouldOverlap(lat,lng)) { setStatus('Too close to an existing pin (needs ≥ ~10 ft).'); return; }
      const ok = confirm(`Add a pin here?\n${lat.toFixed(6)}, ${lng.toFixed(6)}`);
      if (!ok) return;
      const name = autoName(lat,lng);
      const {data, error} = await sb.from('pins').insert({
        name, lat, lng, radius_m: PIN_RADIUS_M,
        model_url: null, track_title: null, track_artist: null, cover_url: null, audio_url: null
      }).select().single();
      if(error){ alert(error.message); return; }
      state.pins.unshift(data);
      renderPins();
      setStatus(`Added: ${name}`);
      if (isMobile() && !sheet.classList.contains('open')) openSheet();
    });

    function autoName(lat,lng){
      const now = new Date();
      const hh = now.getHours()%12 || 12, mm = String(now.getMinutes()).padStart(2,'0');
      return `Pin ${Number(lat).toFixed(6)},${Number(lng).toFixed(6)} · ${hh}:${mm}`;
    }

    async function updatePin(id, patch){
      const {data, error} = await sb.from('pins').update(patch).eq('id', id).select().single();
      if(error){ alert('Save failed: ' + error.message); return; }
      const idx = state.pins.findIndex(x=>x.id===id);
      if (idx >= 0) state.pins[idx] = {...state.pins[idx], ...(data || patch)};
      renderPins();
      setStatus('Saved.');
    }

    // Topbar buttons
    $('#openViewer').onclick = ()=> location.href = 'geo1.html';
    $('#locateMe').onclick = snapToMyLocation;

    // boot
    loadPins();
  </script>
</body>
</html>
