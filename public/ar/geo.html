<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flux — Geo AR (Hunt Mode)</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; height:100%; background:transparent !important; }
    /* Our UI */
    #hud {
      position:fixed; left:0; right:0; top:0; padding:8px 12px;
      color:#fff; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,0)); z-index:10; white-space:pre-wrap;
    }
    #status { opacity:.95 }
    #start {
      position:fixed; left:12px; bottom:12px; z-index:11;
      padding:10px 14px; border:0; border-radius:10px;
      background:#0a84ff; color:#fff; font:600 14px system-ui;
    }
    #arrow {
      position:fixed; right:12px; bottom:12px; width:56px; height:56px; z-index:11;
      border-radius:50%; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(6px);
    }
    #arrow svg { width:34px; height:34px; transform-origin:50% 50%; }

    /* If AR.js ever injects a loader, hide it */
    .arjs-loader, .arjs-loader * { display:none !important; opacity:0 !important; visibility:hidden !important; }
  </style>
</head>
<body>
  <div id="hud">
    <div id="title">Flux — Geo AR (Hunt Mode)</div>
    <div id="status">Tap “Start AR” and allow Camera + Precise Location.</div>
  </div>
  <button id="start">Start AR</button>
  <div id="arrow" title="Turn until arrow points up">
    <svg viewBox="0 0 24 24" fill="#fff"><path d="M12 2l4.5 8h-9L12 2zm0 5a1 1 0 110 2 1 1 0 010-2zM10 22v-8h4v8h-4z"/></svg>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="alpha: true; antialias: true"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; uiEnabled: false"  <!-- disable AR.js UI -->
    style="background: transparent !important"
  >
    <!-- Real GPS camera -->
    <a-camera id="cam" gps-camera rotation-reader></a-camera>

    <!-- Flux: always 3m ahead (fallback) + GPS-anchored to target -->
    <a-entity id="flux"
      gltf-model="https://scanpacks.b-cdn.net/Walking%20Flux%20Main/Flux.glb"
      scale="0.5 0.5 0.5"
      position="0 0 -3"
      look-at="[gps-camera]"
      visible="true"
      cursor="rayOrigin: mouse"
      raycaster="objects: #flux"
    ></a-entity>
  </a-scene>

  <script>
    // Aggressively remove any AR.js loader overlay that might appear
    function nukeArJsLoader() {
      const els = Array.from(document.querySelectorAll('.arjs-loader, [class*="arjs-loader"]'));
      for (const el of els) { if (el && el.parentNode) el.parentNode.removeChild(el); }
    }
    // Try for a few seconds in case AR.js injects late
    document.addEventListener('DOMContentLoaded', () => {
      let tries = 0;
      const iv = setInterval(() => { nukeArJsLoader(); if (++tries > 40) clearInterval(iv); }, 200);
    });
    window.addEventListener('load', nukeArJsLoader);

    // URL params
    const q = new URLSearchParams(location.search);
    const title = q.get('title') || 'Flux';
    const targetLat = parseFloat(q.get('lat') || '');
    const targetLng = parseFloat(q.get('lng') || '');
    const link = q.get('link') || '';

    const titleEl  = document.getElementById('title');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('start');
    const arrowSVG = document.querySelector('#arrow svg');
    const fluxEl   = document.getElementById('flux');

    titleEl.textContent = `${title} — Geo AR (Hunt Mode)`;

    // Utils
    const toRad = v => v * Math.PI/180;
    const toDeg = v => v * 180/Math.PI;
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function bearing(lat1, lon1, lat2, lon2){
      const y = Math.sin(toRad(lon2-lon1)) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
      return (toDeg(Math.atan2(y,x)) + 360) % 360;
    }

    // iOS motion/compass permission
    async function requestMotion(){
      try{
        if (typeof DeviceMotionEvent !== 'undefined' &&
            typeof DeviceMotionEvent.requestPermission === 'function') {
          await DeviceMotionEvent.requestPermission();
        }
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          await DeviceOrientationEvent.requestPermission();
        }
      }catch(_) {}
    }

    // Track heading for arrow
    let deviceHeading = null;
    window.addEventListener('deviceorientationabsolute', e => {
      if (e.absolute && typeof e.alpha === 'number') deviceHeading = (360 - e.alpha) % 360;
    }, true);
    window.addEventListener('deviceorientation', e => {
      if (typeof e.webkitCompassHeading === 'number') deviceHeading = e.webkitCompassHeading; // iOS
    }, true);

    // Start flow
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      startBtn.textContent = 'Starting…';
      await requestMotion();

      if (!navigator.geolocation){
        statusEl.textContent = 'Geolocation not supported.';
        startBtn.textContent = 'Start AR';
        startBtn.disabled = false;
        return;
      }

      let fixes = 0;
      navigator.geolocation.watchPosition(pos => {
        fixes++;
        const { latitude, longitude, accuracy } = pos.coords;

        // Make absolutely sure no overlay covers the camera
        nukeArJsLoader();
        document.body.style.background = 'transparent';

        // Anchor Flux to the GPS target (keep 3m fallback visible)
        if (Number.isFinite(targetLat) && Number.isFinite(targetLng)) {
          fluxEl.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLng};`);
        }

        // HUD
        let line = `Fixes: ${fixes}  Acc: ${Math.round(accuracy||0)} m\nLat: ${latitude.toFixed(5)}  Lng: ${longitude.toFixed(5)}`;
        if (Number.isFinite(targetLat) && Number.isFinite(targetLng)) {
          const dKm = haversine(latitude, longitude, targetLat, targetLng);
          line += dKm < 0.01 ? `\nDistance: ${(dKm*1000).toFixed(0)} m` : `\nDistance: ${dKm.toFixed(2)} km`;
        } else {
          line += `\nNo target set (?lat=&lng=)`;
        }
        statusEl.textContent = line;

        // Arrow toward target
        if (deviceHeading != null && Number.isFinite(targetLat) && Number.isFinite(targetLng)){
          const brg = bearing(latitude, longitude, targetLat, targetLng);
          const turn = (brg - deviceHeading + 360) % 360;
          arrowSVG.style.transform = `rotate(${turn}deg)`;
        }

        // Running → hide start
        startBtn.style.display = 'none';
      }, err => {
        statusEl.textContent = `Location error: ${err.message}`;
        startBtn.textContent = 'Start AR';
        startBtn.disabled = false;
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    });

    // Optional: tap Flux to open a link
    if (link){
      fluxEl.addEventListener('click', ()=>{ window.location.href = link; });
    }
  </script>
</body>
</html>
