<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Geo AR — Drop-in Viewer</title>

  <!-- A-Frame + AR.js (stable combo) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.3.3/aframe/build/aframe-ar-nft.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    #hud {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.6); color:#fff; font:14px system-ui;
      padding:8px 12px; border-radius:10px; z-index:10; text-align:center;
    }
    #hud small { opacity:.8; }
    #btns { margin-top:6px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    button { padding:6px 10px; border:0; border-radius:8px; font-weight:700; cursor:pointer; }
    #motionGate {
      position:fixed; inset:0; display:none; place-items:center; z-index:9999;
      background:rgba(0,0,0,.85); color:#fff; text-align:center; padding:24px;
      font:16px system-ui;
    }
    #motionGate button { margin-top:12px; }
  </style>
</head>
<body>
  <!-- iOS motion permission gate -->
  <div id="motionGate">
    <div>
      <div style="font-weight:700;font-size:18px;margin-bottom:6px">Enable motion & camera</div>
      <div>Tap allow to enable motion/orientation for AR on iPhone.</div>
      <button id="enableMotion">Enable</button>
    </div>
  </div>

  <div id="hud">
    <div id="status">Loading…</div>
    <small id="coords"></small>
    <div id="btns">
      <button id="bigger">Scale +</button>
      <button id="smaller">Scale −</button>
      <button id="spin">Spin</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled:false"
    renderer="antialias:true; alpha:true;"
    embedded
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; trackingMethod: best;">

    <!-- AR.js GPS camera (no rotation-reader) -->
    <a-camera gps-camera></a-camera>

    <!-- Our model -->
    <a-entity id="model"
      gltf-model=""
      crossorigin="anonymous"
      gps-entity-place="latitude:0; longitude:0;"
      scale="1 1 1"
      rotation="0 0 0"
      animation__spin="property: rotation; to: 0 360 0; loop: true; dur: 8000; autoplay: false">
    </a-entity>
  </a-scene>

  <script>
    // --- Utils ---
    const $ = sel => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const toNum = v => (v==null ? NaN : Number(v));

    // Required URL params
    const lat = toNum(params.get('lat'));
    const lng = toNum(params.get('lng'));
    const modelUrl = params.get('model') ||
      'https://recordcatcher.b-cdn.net/glb/NDE1%20record.glb'; // default

    const statusEl = $('#status');
    const coordsEl = $('#coords');
    const modelEl = $('#model');

    // Validate
    if (isNaN(lat) || isNaN(lng)) {
      statusEl.textContent = 'Missing or invalid lat/lng in URL.';
    } else {
      coordsEl.textContent = `lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`;
    }

    // Apply model + position
    modelEl.setAttribute('gltf-model', modelUrl);
    modelEl.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);

    // Controls
    let baseScale = 1;
    $('#bigger').onclick = () => {
      baseScale *= 1.25;
      modelEl.setAttribute('scale', `${baseScale} ${baseScale} ${baseScale}`);
    };
    $('#smaller').onclick = () => {
      baseScale = Math.max(0.1, baseScale / 1.25);
      modelEl.setAttribute('scale', `${baseScale} ${baseScale} ${baseScale}`);
    };
    let spinning = false;
    $('#spin').onclick = () => {
      spinning = !spinning;
      modelEl.setAttribute('animation__spin',
        `property: rotation; to: 0 360 0; loop: true; dur: 8000; autoplay: ${spinning}`);
    };
    $('#reset').onclick = () => {
      baseScale = 1;
      spinning = false;
      modelEl.setAttribute('scale', '1 1 1');
      modelEl.setAttribute('rotation', '0 0 0');
      modelEl.setAttribute('animation__spin',
        'property: rotation; to: 0 360 0; loop: true; dur: 8000; autoplay: false');
    };

    // Helpful status
    window.addEventListener('gps-camera-update-position', () => {
      statusEl.textContent = 'GPS locked. Walk toward the target point.';
    });
    window.addEventListener('gps-camera-origin-coord-set', () => {
      statusEl.textContent = 'Origin set. Rendering model at target.';
    });

    // iOS motion permission flow
    document.addEventListener('DOMContentLoaded', async () => {
      statusEl.textContent = 'Allow camera, motion & location. If blank, reload and move phone.';

      const gate = document.getElementById('motionGate');
      const btn = document.getElementById('enableMotion');

      const needsIOSPermission =
        typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function';

      if (needsIOSPermission) {
        gate.style.display = 'grid';
        btn.onclick = async () => {
          try {
            const res = await DeviceMotionEvent.requestPermission();
            // Some iOS versions also require orientation:
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
              try { await DeviceOrientationEvent.requestPermission(); } catch (_) {}
            }
            if (res === 'granted') gate.style.display = 'none';
          } catch (e) {
            console.warn('Motion permission error:', e);
          }
        };
      }
    });
  </script>
</body>
</html>
