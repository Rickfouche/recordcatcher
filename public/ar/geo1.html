<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RecordCatcher — Finder Mode</title>

  <!-- A-Frame + AR.js (geo) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar-nft.js"></script>
  <!-- Supabase (only to load a drop by id) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:15px system-ui}
    .hud{position:fixed;inset:auto 0 0 0;display:grid;gap:8px;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.6) 20%,rgba(0,0,0,.8))}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{background:#111;border:1px solid #222;border-radius:999px;padding:8px 12px;opacity:.9}
    .ok{color:#0f0}
    .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:700;cursor:pointer}
    .blue{background:#0a84ff;color:#fff}
    .muted{opacity:.8}

    /* Tiny direction arrow */
    .arrow{font-size:28px;line-height:1;display:inline-block;transform:rotate(0deg);transition:transform .1s linear}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
    .card{background:#111;border:1px solid #222;border-radius:16px;padding:16px;max-width:420px;width:92vw;display:grid;gap:12px}
    .cover{width:100%;height:auto;border-radius:12px;border:1px solid #222;object-fit:cover;background:#000}
    .title{font-weight:800;font-size:18px}
    .rowc{display:flex;gap:10px;align-items:center;justify-content:space-between}
  </style>
</head>
<body>

<!-- AR Scene -->
<a-scene
  vr-mode-ui="enabled:false"
  renderer="antialias:true; alpha:true"
  embedded
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; trackingMethod: best; gpsMinDistance: 1;"
>
  <!-- Camera with GPS -->
  <a-camera gps-camera rotation-reader></a-camera>

  <!-- The record model (inserted dynamically once target loads) -->
  <a-entity id="dropEntity"></a-entity>
</a-scene>

<!-- HUD -->
<div class="hud">
  <div class="row">
    <div class="pill" id="name">Loading…</div>
    <div class="pill" id="distance">—</div>
  </div>
  <div class="row">
    <div class="pill" id="direction"><span class="arrow" id="arrow">➤</span> <span id="heading">—°</span></div>
    <div style="display:flex;gap:8px">
      <button class="btn blue" id="sensors">Enable Compass</button>
      <button class="btn blue" id="recenter">Recenter</button>
      <a class="muted" id="openMaps" target="_blank" rel="noopener">Open in Maps</a>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <div class="title" id="mTitle">Track</div>
    <img id="mCover" class="cover" alt="" style="display:none" />
    <audio id="mAudio" controls preload="none" style="width:100%"></audio>
    <div class="rowc">
      <button class="btn" id="close">Close</button>
      <button class="btn blue" id="playBtn">Play</button>
    </div>
    <div class="muted" id="mHint">Tap Play to start audio.</div>
  </div>
</div>

<script>
/* -----------------------------
   CONFIG / FLAGS
----------------------------- */
const STRICT_RANGE_TO_TAP = true; // require being within radius to open popup
const DEFAULT_RADIUS_M = 15;      // used if radius not provided

/* -----------------------------
   URL / Supabase
----------------------------- */
const qs = new URLSearchParams(location.search);

// Supabase only needed for ?drop_id=...
const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co'; // TODO
const SUPABASE_ANON = 'YOUR-ANON-KEY';                    // TODO
const sb = (SUPABASE_URL.includes('YOUR-PROJECT')) ? null
        : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* -----------------------------
   State / Elements
----------------------------- */
let target = {
  id: null,
  lat: null, lng: null,
  radius_m: DEFAULT_RADIUS_M,
  title: 'Track',
  glb_url: null,
  audio_url: null,
  cover_url: null
};
let userPos = { lat:null, lng:null, acc:null };
let compassHeading = 0; // 0..360 (0 = North)

const elName = document.getElementById('name');
const elDist = document.getElementById('distance');
const elMaps = document.getElementById('openMaps');
const elRec  = document.getElementById('recenter');
const elSensors = document.getElementById('sensors');
const elArrow= document.getElementById('arrow');
const elHead = document.getElementById('heading');

// Modal refs
const modal   = document.getElementById('modal');
const mTitle  = document.getElementById('mTitle');
const mAudio  = document.getElementById('mAudio');
const mCover  = document.getElementById('mCover');
const playBtn = document.getElementById('playBtn');
const closeBtn= document.getElementById('close');

/* -----------------------------
   Utils
----------------------------- */
function toRad(d){ return d*Math.PI/180; }
function haversine(lat1, lon1, lat2, lon2){
  if([lat1,lon1,lat2,lon2].some(v=>typeof v!=='number')) return NaN;
  const R=6371000,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function bearingBetween(lat1, lon1, lat2, lon2){
  const φ1=toRad(lat1), φ2=toRad(lat2), λ1=toRad(lon1), λ2=toRad(lon2);
  const y = Math.sin(λ2-λ1) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  return (Math.atan2(y, x)*180/Math.PI + 360) % 360; // deg
}
function fmtMeters(m){
  if(!isFinite(m)) return '—';
  return m<1000? `${Math.round(m)} m` : `${(m/1000).toFixed(2)} km`;
}
function mapsLink(lat,lng){ return `https://maps.apple.com/?daddr=${lat},${lng}`; }

/* -----------------------------
   Load target
----------------------------- */
async function loadTarget(){
  if(qs.has('drop_id') && sb){
    target.id = qs.get('drop_id');
    const { data, error } = await sb
      .from('drops')
      .select('id, radius_m, raw_point, capture_zone, record:record_id(title, audio_url, cover_url, glb_url)')
      .eq('id', target.id)
      .maybeSingle();
    if(error || !data){ elName.textContent = 'Could not load drop.'; return; }

    target.radius_m = Number(data.radius_m || DEFAULT_RADIUS_M);
    target.title    = data.record?.title || 'Track';
    target.audio_url= data.record?.audio_url || null;
    target.cover_url= data.record?.cover_url || null;
    target.glb_url  = data.record?.glb_url   || null;

    // Prefer polygon centroid if present
    if (data.capture_zone?.coordinates?.[0]?.length){
      const ring = data.capture_zone.coordinates[0];
      const avg = ring.reduce((acc,[lng,lat])=>({lat:acc.lat+lat, lng:acc.lng+lng}), {lat:0,lng:0});
      target.lat = avg.lat / ring.length;
      target.lng = avg.lng / ring.length;
    }
    // Fallback to raw_point
    if ((!target.lat||!target.lng) && data.raw_point){
      if (typeof data.raw_point === 'string' && data.raw_point.startsWith('POINT')){
        const nums = data.raw_point.match(/-?\d+(\.\d+)?/g)?.map(Number) || [];
        target.lng = nums[0]; target.lat = nums[1];
      } else if (data.raw_point.lat && data.raw_point.lng){
        target.lat = data.raw_point.lat; target.lng = data.raw_point.lng;
      }
    }
  } else {
    // Direct params (debug / from map Find button)
    target.lat      = parseFloat(qs.get('lat'));
    target.lng      = parseFloat(qs.get('lng'));
    target.radius_m = parseFloat(qs.get('radius')) || DEFAULT_RADIUS_M;
    target.title    = qs.get('title') || 'Track';
    // decodeURIComponent in case upstream forgot to encode
    target.glb_url  = qs.get('glb')   ? decodeURIComponent(qs.get('glb'))   : null;
    target.audio_url= qs.get('audio') ? decodeURIComponent(qs.get('audio')) : null;
    target.cover_url= qs.get('cover') ? decodeURIComponent(qs.get('cover')) : null;
  }

  elName.textContent = target.title;
  if (target.lat && target.lng) elMaps.href = mapsLink(target.lat, target.lng);

  spawnARModel();
}

/* -----------------------------
   Spawn GLB
----------------------------- */
function spawnARModel(){
  const root = document.getElementById('dropEntity');
  root.innerHTML = '';

  if(!target.lat || !target.lng){
    elName.textContent = 'Missing coordinates.';
    return;
  }
  const container = document.createElement('a-entity');
  container.setAttribute('gps-entity-place', `latitude: ${target.lat}; longitude: ${target.lng};`);
  container.setAttribute('look-at', '[gps-camera]');

  const model = document.createElement('a-entity');
  if (target.glb_url){
    model.setAttribute('gltf-model', target.glb_url);
  } else {
    // fallback shape if no GLB provided
    model.setAttribute('geometry', 'primitive: box; depth: 0.2; height: 0.2; width: 0.2');
    model.setAttribute('material', 'color: #4af');
  }
  model.setAttribute('scale', '1 1 1');
  model.setAttribute('position', '0 1 0'); // ~1m high
  model.setAttribute('shadow', 'cast: true; receive: false');

  // Manual, intentional interaction — only open if in-range (if STRICT on)
  model.addEventListener('click', () => {
    const d = haversine(userPos.lat, userPos.lng, target.lat, target.lng);
    const inRange = d <= (target.radius_m || DEFAULT_RADIUS_M);
    if (STRICT_RANGE_TO_TAP && !inRange){
      // gentle nudge
      const msg = document.createElement('div');
      msg.style.cssText='position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:#111;border:1px solid #333;border-radius:12px;padding:8px 12px;color:#fff;z-index:10000';
      msg.textContent = `Move closer to unlock · ${fmtMeters(d)}`;
      document.body.appendChild(msg);
      setTimeout(()=>msg.remove(), 1400);
      return;
    }
    openModal();
  });

  // Optional: basic load/error hooks
  model.addEventListener('model-error', () => {
    elName.textContent = 'Model failed to load (check URL / CORS).';
  });

  container.appendChild(model);
  root.appendChild(container);
}

/* -----------------------------
   Sensors / Distance / Bearing
----------------------------- */
function startDistanceWatch(){
  if(!navigator.geolocation) return;
  navigator.geolocation.watchPosition((pos)=>{
    userPos.lat = pos.coords.latitude;
    userPos.lng = pos.coords.longitude;
    userPos.acc = typeof pos.coords.accuracy === 'number' ? Math.round(pos.coords.accuracy) : null;
    const d = haversine(userPos.lat, userPos.lng, target.lat, target.lng);
    elDist.textContent = d <= target.radius_m
      ? `In range (${fmtMeters(d)})${userPos.acc? ' · ±'+userPos.acc+'m':''}`
      : `${fmtMeters(d)}${userPos.acc? ' · ±'+userPos.acc+'m':''}`;
    elDist.classList.toggle('ok', d <= target.radius_m);

    // live bearing → rotate arrow toward target
    if (isFinite(d) && isFinite(compassHeading)){
      const brgTo = bearingBetween(userPos.lat, userPos.lng, target.lat, target.lng);
      const rel = (brgTo - compassHeading + 360) % 360;
      elArrow.style.transform = `rotate(${rel}deg)`;
    }
  }, ()=>{}, { enableHighAccuracy:true, maximumAge:1000, timeout:15000 });
}

// iOS 13+ requires explicit permission for compass
async function requestCompassPermissionIfNeeded(){
  try{
    const need = typeof DeviceOrientationEvent !== 'undefined' &&
                 typeof DeviceOrientationEvent.requestPermission === 'function';
    if (need){
      const res = await DeviceOrientationEvent.requestPermission();
      return res === 'granted';
    }
    return true;
  }catch{ return false; }
}

function startCompass(){
  window.addEventListener('deviceorientation', (e)=>{
    const webkit = e.webkitCompassHeading;
    if (typeof webkit === 'number'){
      compassHeading = webkit; // 0 = North
    } else if (typeof e.alpha === 'number'){
      compassHeading = (360 - e.alpha) % 360; // approx
    }
    elHead.textContent = `${Math.round((compassHeading+360)%360)}°`;
  }, true);
}

/* -----------------------------
   Modal
----------------------------- */
function openModal(){
  mTitle.textContent = target.title || 'Track';
  if (target.cover_url){
    mCover.src = target.cover_url;
    mCover.style.display = 'block';
  } else {
    mCover.style.display = 'none';
  }
  if (target.audio_url){
    mAudio.src = target.audio_url;
    playBtn.disabled = false;
  } else {
    mAudio.removeAttribute('src');
    playBtn.disabled = true;
  }
  modal.style.display = 'grid';
}
function closeModal(){
  modal.style.display = 'none';
  mAudio.pause();
}
playBtn.addEventListener('click', ()=> mAudio.play());
closeBtn.addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

/* -----------------------------
   UI buttons
----------------------------- */
document.getElementById('recenter').addEventListener('click', ()=>{
  alert('Recenter: move your phone in a small figure-8 to recalibrate. The record is at the target GPS point.');
});
elSensors.addEventListener('click', async ()=>{
  const ok = await requestCompassPermissionIfNeeded();
  if (ok) { startCompass(); elSensors.disabled = true; elSensors.textContent = 'Compass On'; }
});

/* -----------------------------
   Boot
----------------------------- */
loadTarget();
startDistanceWatch();
</script>
</body>
</html>
